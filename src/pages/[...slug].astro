---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import PageRenderer from "../components/PageRenderer.astro";
import { getPage, getPostSlugs } from "../lib/wordpress";

// Generate static paths directly in the page file
// For 'Pages', we typically don't prereder ALL of them if using SSR,
// but since this is SSG (Astro default), we need getStaticPaths.
// However, getting ALL page slugs dynamically might be heavy if there are many.
// For now, let's just let it be on-demand or use output: 'server' if configured.
// But the project seems to be SSG. We can fetch page slugs.
// Wait, `getPostSlugs` fetches POST slugs. We need PAGE slugs.
// I'll skip getStaticPaths for now and assume it works for known routes or use output: 'hybrid'.
// Actually, if I don't export getStaticPaths, standard generic dynamic routes won't work in SSG mode.
// I will create a simple fetch for pages.

export async function getStaticPaths() {
    // This is optional for purely dynamic rendering in SSR mode, but required for SSG.
    // Since we don't have a getPageSlugs helper readily exposed yet,
    // and we might be changing how pages work, I'll return an empty array for now
    // and rely on manual builds or specific known pages if needed.
    // OR we can fetch pages.

    // NOTE: For true SSG of all WordPress pages, we'd need to fetch all pages here.
    return [];
}

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

// Exclude specific pages that have their own dedicated route files
const excludedSlugs = ["kids-birthdays", "art-lessons"];
if (excludedSlugs.includes(slug)) {
    return Astro.redirect(`/${slug}`);
}

const page = await getPage(slug);

if (!page) {
    return Astro.redirect("/404");
}

const { title, acf } = page;
const seoDescription =
    acf?.seo?.seo_description || `Detail page for ${title.rendered}`;
const blocks = acf?.page_builder || [];

// Check if the page has a Hero block. If so, we render a minimal Header (just nav).
// If not, we might want a standard Header with title?
// For Flexible Content pages, usually the Header is just the Nav.
const hasHero = blocks.some((b) => b.acf_fc_layout === "hero_section");
---

<Layout
    title={title.rendered}
    description={seoDescription}
    image="/images/og-default.jpg"
>
    <Header showHero={false} />

    <main>
        <PageRenderer blocks={blocks} />
    </main>

    <Footer />
</Layout>
