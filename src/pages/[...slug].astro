---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import PageHeader from "../components/PageHeader.astro";
import PageRenderer from "../components/PageRenderer.astro";
import {
    getPage,
    getPageSlugs,
    getPost,
    getPostSlugs,
    decodeHtmlEntities,
    formatDate,
    getAuthorName,
    getFeaturedImageUrl,
} from "../lib/wordpress";

/**
 * Generate static paths for all WordPress pages AND posts at build time.
 * Both content types use root-level URLs per the site's URL structure.
 */
export async function getStaticPaths() {
    try {
        const [pageSlugs, postSlugs] = await Promise.all([
            getPageSlugs(),
            getPostSlugs(),
        ]);

        const pagePaths = pageSlugs.map((slug) => ({
            params: { slug },
            props: { type: "page" },
        }));

        const postPaths = postSlugs.map((slug) => ({
            params: { slug },
            props: { type: "post" },
        }));

        return [...pagePaths, ...postPaths];
    } catch (error) {
        console.error(
            "Failed to fetch WordPress slugs for static paths:",
            error,
        );
        return [];
    }
}

const { slug } = Astro.params;
const { type } = Astro.props;

if (!slug) {
    return Astro.redirect("/404");
}

// Exclude specific pages that have their own dedicated route files
const excludedSlugs = ["kids-birthdays", "art-lessons"];
if (excludedSlugs.includes(slug)) {
    return Astro.redirect(`/${slug}`);
}

// Handle based on content type
let content: any = null;
let isPost = false;

if (type === "post") {
    content = await getPost(slug);
    isPost = true;
} else if (type === "page") {
    content = await getPage(slug);
} else {
    // Fallback: try page first, then post
    content = await getPage(slug);
    if (!content) {
        content = await getPost(slug);
        isPost = !!content;
    }
}

if (!content) {
    return Astro.redirect("/404");
}

// Page-specific data
const title = decodeHtmlEntities(content.title.rendered);

// Post-specific data
const date = isPost ? new Date(content.date) : null;
const author = isPost ? getAuthorName(content) : null;
const featuredImage = isPost ? getFeaturedImageUrl(content, "large") : null;

// SEO description
const seoDescription = isPost
    ? content.acf?.description ||
      decodeHtmlEntities(
          content.excerpt.rendered.replace(/<[^>]*>/g, ""),
      ).substring(0, 160)
    : content.acf?.seo?.seo_description || `Detail page for ${title}`;

// Page builder blocks (for pages only)
const blocks = !isPost ? content.acf?.page_builder || [] : [];
---

{
    isPost ? (
        <Layout
            title={`${title} | It's An Art Party Blog`}
            description={seoDescription}
            image={featuredImage || "/images/og-blog.jpg"}
        >
            <Header showHero={false} />
            <PageHeader title="BLOG" subtitle="" />

            <main class="max-w-4xl mx-auto px-6 py-12">
                <article itemscope itemtype="https://schema.org/BlogPosting">
                    <header class="mb-8">
                        <h1
                            class="text-3xl md:text-4xl lg:text-5xl font-display text-brand-teal mb-4 leading-tight"
                            itemprop="headline"
                        >
                            {title}
                        </h1>
                        <div class="text-gray-400 text-sm font-body uppercase tracking-widest">
                            <span
                                itemprop="author"
                                itemscope
                                itemtype="https://schema.org/Person"
                            >
                                <span itemprop="name">{author}</span>
                            </span>{" "}
                            /{" "}
                            <time
                                datetime={date?.toISOString()}
                                itemprop="datePublished"
                            >
                                {date && formatDate(date.toISOString())}
                            </time>
                        </div>
                    </header>

                    {featuredImage && (
                        <div class="mb-8">
                            <img
                                src={featuredImage}
                                alt={title}
                                class="w-full h-auto rounded-lg shadow-lg"
                                itemprop="image"
                            />
                        </div>
                    )}

                    <div
                        class="prose prose-lg max-w-none blog-content"
                        itemprop="articleBody"
                        set:html={content.content.rendered}
                    />

                    <footer class="mt-12 pt-8 border-t border-gray-200">
                        <a
                            href="/blog"
                            class="inline-flex items-center text-brand-pink font-bold hover:underline"
                        >
                            <svg
                                class="w-4 h-4 mr-2"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M15 19l-7-7 7-7"
                                />
                            </svg>
                            Back to Blog
                        </a>
                    </footer>
                </article>
            </main>

            <Footer />
        </Layout>
    ) : (
        <Layout
            title={title}
            description={seoDescription}
            image="/images/og-default.jpg"
        >
            <Header showHero={false} />

            <main>
                <PageRenderer blocks={blocks} />
            </main>

            <Footer />
        </Layout>
    )
}

<style is:global>
    .blog-content {
        font-family: var(--font-body);
    }

    .blog-content h1,
    .blog-content h2,
    .blog-content h3,
    .blog-content h4 {
        font-family: var(--font-display);
        color: var(--color-brand-teal);
        margin-top: 2rem;
        margin-bottom: 1rem;
    }

    .blog-content h2 {
        font-size: 1.75rem;
    }

    .blog-content h3 {
        font-size: 1.5rem;
    }

    .blog-content p {
        margin-bottom: 1.5rem;
        line-height: 1.8;
        color: #4a5568;
    }

    .blog-content a {
        color: var(--color-brand-pink);
        text-decoration: underline;
    }

    .blog-content a:hover {
        color: var(--color-brand-teal);
    }

    .blog-content ul,
    .blog-content ol {
        margin-bottom: 1.5rem;
        padding-left: 1.5rem;
    }

    .blog-content li {
        margin-bottom: 0.5rem;
        line-height: 1.7;
    }

    .blog-content img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin: 1.5rem 0;
    }

    .blog-content blockquote {
        border-left: 4px solid var(--color-brand-pink);
        padding-left: 1.5rem;
        margin: 1.5rem 0;
        font-style: italic;
        color: #718096;
    }
</style>
