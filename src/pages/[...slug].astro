---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import PageRenderer from "../components/PageRenderer.astro";
import { getPage, getPageSlugs } from "../lib/wordpress";

/**
 * Generate static paths for all WordPress pages at build time.
 * Pages with dedicated .astro files (home, about, contact, etc.) are excluded
 * since they have their own route handlers.
 */
export async function getStaticPaths() {
    try {
        const slugs = await getPageSlugs();
        return slugs.map((slug) => ({
            params: { slug },
        }));
    } catch (error) {
        console.error(
            "Failed to fetch WordPress page slugs for static paths:",
            error,
        );
        return [];
    }
}

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

// Exclude specific pages that have their own dedicated route files
const excludedSlugs = ["kids-birthdays", "art-lessons"];
if (excludedSlugs.includes(slug)) {
    return Astro.redirect(`/${slug}`);
}

const page = await getPage(slug);

if (!page) {
    return Astro.redirect("/404");
}

const { title, acf } = page;
const seoDescription =
    acf?.seo?.seo_description || `Detail page for ${title.rendered}`;
const blocks = acf?.page_builder || [];

// Check if the page has a Hero block. If so, we render a minimal Header (just nav).
// If not, we might want a standard Header with title?
// For Flexible Content pages, usually the Header is just the Nav.
const hasHero = blocks.some((b) => b.acf_fc_layout === "hero_section");
---

<Layout
    title={title.rendered}
    description={seoDescription}
    image="/images/og-default.jpg"
>
    <Header showHero={false} />

    <main>
        <PageRenderer blocks={blocks} />
    </main>

    <Footer />
</Layout>
